{% extends "base.html" %}
{% block title %}Editar – {{ video.title }}{% endblock %}

{% block content %}
<h1 class="mb-4">Editar Vídeo #{{ video.id }}</h1>
<form id="editForm" action="/admin/edit/{{ video.id }}" method="post" enctype="multipart/form-data" class="row g-3">
  <div class="col-md-6">
    <label class="form-label">Título</label>
    <input name="title" class="form-control" value="{{ video.title }}" required>
  </div>
  <div class="col-md-6">
    <label class="form-label">Duração (s)</label>
    <input name="duration" type="number" class="form-control" value="{{ video.duration }}" required min="0" max="9999">
  </div>
  <div class="col-12">
    <label class="form-label">Descrição</label>
    <textarea name="description" class="form-control" rows="3">{{ video.description }}</textarea>
  </div>
  <div class="col-12">
    <label class="form-label">Ficheiro (MP4)</label>
    <input name="file" type="file" class="form-control" accept="video/mp4">
  </div>
  <div class="col-12">
    <button id="saveBtn" class="btn btn-primary">
      <i class="bi bi-save"></i> Guardar
    </button>
    <a href="/admin" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById('editForm').addEventListener('submit', async e => {
    e.preventDefault();
    if (!confirm('Tem a certeza que quer guardar as alterações?')) {
      return;}
    const form = e.target;
    const btn  = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> A Guardar...`;

    try {
      const data = new FormData(form);
      const resp = await fetch(form.action, { method: 'POST', body: data });
      
      if (resp.ok) {
        showToast('Vídeo atualizado com sucesso');
        setTimeout(() => window.location.href = '/admin', 1500);
      } else {
        const error = await resp.json();
        showToast(error.detail || 'Erro ao atualizar o vídeo', true);
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-save"></i> Guardar`;
      }
    } catch (error) {
      console.error('Erro:', error);
      showToast('Erro ao comunicar com o servidor', true);
      btn.disabled = false;
      btn.innerHTML = `<i class="bi bi-save"></i> Guardar`;
    }
  });

  function showToast(msg, isError = false) {
    const tc = document.createElement('div');
    tc.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    tc.innerHTML = `
      <div class="toast align-items-center text-white ${isError?'bg-danger':'bg-success'} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`;
    document.body.append(tc);
    const bsToast = new bootstrap.Toast(tc.querySelector('.toast'));
    bsToast.show();
    tc.querySelector('.toast').addEventListener('hidden.bs.toast', () => tc.remove());
  }
</script>
{% endblock %}